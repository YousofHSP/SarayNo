@using Common.Utilities
@using Data.Contracts
@using Domain
@using Microsoft.EntityFrameworkCore
@using Presentation.Helpers
@inject IRepository<Invoice> InvoiceRepository;
@inject IRepository<Project> ProjectRepository;

@{
  var projects = await ProjectRepository.TableNoTracking
    .Include(i => i.Invoices)
    .ToListAsync();
  var doneProjects = projects.Where(i => i.Invoices.Any() && i.Invoices.All(n => n.Type == InvoiceType.Settled)).ToList();
  var activeProjects = projects.Where(i => i.Invoices.Any(n => n.Type != InvoiceType.Settled)).ToList();
  var allProjectsCost = projects.SelectMany(i => i.Invoices).Where(i => i.Type == InvoiceType.Settled).Sum(i => i.Amount);
  var allUnsetteldAmount = projects.SelectMany(i => i.Invoices).Where(i => i.Type == InvoiceType.Unsettled).Sum(i => i.Amount);

  Layout = "_Layout";
}
<h3>داشبورد</h3>
<div class="container mb-5">
  @if (CheckPermission.Check(User, "Dashboard.Index"))
  {
    <div class="row g-4">

      <!-- Card: تعداد کل پروژه‌ها -->
      <div class="col-md-4">
        <div class="card dashboard-card p-3 text-center">
          <div class="section-title">تعداد کل پروژه‌ها</div>
          <div class="stat-value">@projects.Count</div>
        </div>
      </div>

      <!-- Card: پروژه‌های فعال -->
      <div class="col-md-4">
        <div class="card dashboard-card p-3 text-center">
          <div class="section-title">پروژه‌های فعال</div>
          <div class="stat-value text-success">@activeProjects.Count</div>
        </div>
      </div>

      <!-- Card: پروژه‌های تکمیل‌شده -->
      <div class="col-md-4">
        <div class="card dashboard-card p-3 text-center">
          <div class="section-title">پروژه‌های تکمیل‌شده</div>
          <div class="stat-value text-muted">@doneProjects.Count</div>
        </div>
      </div>

      <!-- Card: بودجه کل -->
      <div class="col-md-6">
        <div class="card dashboard-card p-3 text-center">
          <div class="section-title">مجموع کل هزینه پروژه ها</div>
          <div class="stat-value">@allProjectsCost.ToNumeric()</div>
        </div>
      </div>

      <!-- Card: میزان پرداخت شده -->
      <div class="col-md-6">
        <div class="card dashboard-card p-3 text-center">
          <div class="section-title">مبلغ های تسویه نشده</div>
          <div class="stat-value text-info">@allUnsetteldAmount.ToNumeric()</div>
        </div>
      </div>

    </div>

    <div class="mt-5">
      <h4 class="section-title">درصد مشارکت پروژه</h4>
      <div class="card p-3">
        @foreach (var item in activeProjects)
        {
          <div class="mb-3">
            <label class="form-label">@item.Title</label>
            <div class="progress project-progress">
              <div class="progress-bar bg-success" style="width: @(item.Percent)%;">@((int)item.Percent)%</div>
            </div>
          </div>
        }
      </div>
    </div>
  }


  <!-- Progress Section -->


</div>

@section Styles{

  <style>
    .dashboard-card {
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .dashboard-card:hover {
      transform: translateY(-5px);
    }

    .section-title {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      font-weight: bold;
      color: #003366;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: bold;
      color: #007bff;
    }

    .bg-gradient-header {
      background: linear-gradient(135deg, #d4af37, #003366);
      color: white;
      padding: 2rem;
      border-radius: 0 0 40px 40px;
    }

    .project-progress {
      height: 10px;
      border-radius: 5px;
    }
  </style>}